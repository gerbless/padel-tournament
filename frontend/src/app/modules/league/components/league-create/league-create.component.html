<div class="container fade-in">
    <div class="wizard-header">
        <h1>Nueva Liga</h1>
        <p style="color: var(--text-secondary);">Configura tu liga paso a paso</p>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
                <div class="step-number">1</div>
                <div class="step-label">Tipo</div>
            </div>
            <div class="progress-line" [class.active]="currentStep > 1"></div>
            <div class="progress-step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
                <div class="step-number">2</div>
                <div class="step-label">Configuraci√≥n</div>
            </div>
            <div class="progress-line" [class.active]="currentStep > 2"></div>
            <div class="progress-step" [class.active]="currentStep >= 3" [class.completed]="currentStep > 3">
                <div class="step-number">3</div>
                <div class="step-label">Jugadores</div>
            </div>
            <div class="progress-line" [class.active]="currentStep > 3"></div>
            <div class="progress-step" [class.active]="currentStep >= 4" [class.completed]="currentStep > 4">
                <div class="step-number">4</div>
                <div class="step-label">Parejas</div>
            </div>
            <div class="progress-line" [class.active]="currentStep > 4"></div>
            <div class="progress-step" [class.active]="currentStep >= 5" [class.completed]="currentStep > 5">
                <div class="step-number">5</div>
                <div class="step-label">Confirmaci√≥n</div>
            </div>
        </div>
    </div>

    <div class="wizard-content">
        <!-- Step 1: Basic Info & Type Selection -->
        <div class="wizard-step" *ngIf="currentStep === 1">
            <h2>Informaci√≥n B√°sica</h2>

            <div class="form-group">
                <label>Nombre de la Liga</label>
                <input type="text" [(ngModel)]="leagueName" placeholder="Ej: Liga Primavera 2024" class="form-control">
            </div>

            <div class="form-group">
                <label>Categor√≠a (Opcional)</label>
                <input type="text" [(ngModel)]="category" placeholder="Ej: Primera, Segunda, Mixta"
                    class="form-control">
            </div>

            <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Tipo de Liga</h3>

            <div class="type-selection">
                <div class="type-card" [class.selected]="leagueType === 'round_robin'"
                    (click)="leagueType = 'round_robin'">
                    <div class="type-icon">üîÑ</div>
                    <h4>Todos contra Todos</h4>
                    <p>Cada pareja juega contra todas las dem√°s. Sistema Round-Robin cl√°sico.</p>
                    <ul>
                        <li>‚úì N√∫mero de rondas configurables</li>
                        <li>‚úì Sugerencias de partidos equilibrados</li>
                        <li>‚úì Ranking din√°mico</li>
                    </ul>
                </div>

                <div class="type-card" [class.selected]="leagueType === 'groups_playoff'"
                    (click)="leagueType = 'groups_playoff'">
                    <div class="type-icon">üèÖ</div>
                    <h4>Grupos + Playoffs</h4>
                    <p>Fase de grupos seguida de eliminatorias (cuartos, semis, final).</p>
                    <ul>
                        <li>‚úì Grupos aleatorios equilibrados</li>
                        <li>‚úì Los mejores avanzan a playoffs</li>
                        <li>‚úì Emoci√≥n de eliminaci√≥n directa</li>
                    </ul>
                </div>

                <div class="type-card" [class.selected]="leagueType === 'round_robin_playoff'"
                    (click)="leagueType = 'round_robin_playoff'">
                    <div class="type-icon">üèÜ</div>
                    <h4>Todos vs Todos + Playoffs</h4>
                    <p>Fase regular round-robin, luego playoffs Oro y Plata seg√∫n clasificaci√≥n.</p>
                    <ul>
                        <li>‚úì Top 4 ‚Üí Liga Oro (SF + Final + 3¬∞)</li>
                        <li>‚úì 5¬∞ al 8¬∞ ‚Üí Liga Plata (SF + Final + 3¬∞)</li>
                        <li>‚úì √öltimas parejas descienden</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Step 2: Configuration -->
        <div class="wizard-step" *ngIf="currentStep === 2">
            <h2>Configuraci√≥n de Partidos y Puntuaci√≥n</h2>

            <div class="config-grid">
                <div class="form-group">
                    <label>Fecha de Inicio</label>
                    <input type="date" [(ngModel)]="startDate" class="form-control">
                </div>

                <div class="form-group" *ngIf="leagueType === 'round_robin' || leagueType === 'round_robin_playoff'">
                    <label>N√∫mero de Rondas</label>
                    <input type="number" [(ngModel)]="config.rounds" min="1" max="5" class="form-control">
                    <small>Cada pareja jugar√° {{ config.rounds }} vez(veces) contra cada rival</small>
                </div>

                <div class="form-group" *ngIf="leagueType === 'groups_playoff'">
                    <label>N√∫mero de Grupos</label>
                    <input type="number" [(ngModel)]="config.numberOfGroups" min="2" max="4" class="form-control">
                </div>

                <div class="form-group" *ngIf="leagueType === 'groups_playoff'">
                    <label>Parejas que avanzan por grupo</label>
                    <input type="number" [(ngModel)]="config.teamsAdvancePerGroup" min="1" max="4" class="form-control">
                </div>

                <div class="form-group full-width" *ngIf="leagueType === 'groups_playoff'">
                    <label class="checkbox-label"
                        style="margin-top: 1rem; background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px;">
                        <input type="checkbox" [(ngModel)]="config.enableMultiTierPlayoffs">
                        <div>
                            <span style="font-weight: 600; font-size: 1rem;">üèÜ Activar Multi-Copas (Oro, Plata,
                                Bronce)</span>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">
                                Divide a los clasificados en copas seg√∫n su posici√≥n en el grupo (ej: 1¬∫ y 2¬∫ a Oro, 3¬∫
                                y 4¬∫ a Plata).
                            </p>
                        </div>
                    </label>
                </div>

                <!-- Round Robin + Playoff specific config -->
                <div class="form-group" *ngIf="leagueType === 'round_robin_playoff'">
                    <label>Parejas en Liga Oro</label>
                    <input type="number" [(ngModel)]="config.goldPlayoffCount" min="2" max="8" class="form-control">
                    <small>Las primeras {{ config.goldPlayoffCount }} clasificadas juegan playoffs Oro</small>
                </div>

                <div class="form-group" *ngIf="leagueType === 'round_robin_playoff'">
                    <label>Parejas en Liga Plata</label>
                    <input type="number" [(ngModel)]="config.silverPlayoffCount" min="2" max="8" class="form-control">
                    <small>Las siguientes {{ config.silverPlayoffCount }} clasificadas juegan playoffs Plata</small>
                </div>

                <div class="form-group" *ngIf="leagueType === 'round_robin_playoff'">
                    <label>Parejas que descienden</label>
                    <input type="number" [(ngModel)]="config.relegationCount" min="0" max="4" class="form-control">
                    <small>Las √∫ltimas {{ config.relegationCount }} parejas descienden de categor√≠a</small>
                </div>

                <div class="form-group full-width" *ngIf="leagueType === 'round_robin_playoff'">
                    <label class="checkbox-label"
                        style="margin-top: 1rem; background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px;">
                        <input type="checkbox" [(ngModel)]="config.skipExhibitionSets">
                        <div>
                            <span style="font-weight: 600; font-size: 1rem;">üéæ Set de exhibici√≥n opcional</span>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">
                                Si una pareja gana 2-0, el 3er set es opcional y no cuenta en la tabla de posiciones.
                            </p>
                        </div>
                    </label>
                </div>
            </div>

            <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Puntuaci√≥n</h3>
            <div class="config-grid">
                <div class="form-group">
                    <label>Puntos por Victoria</label>
                    <input type="number" [(ngModel)]="config.pointsWin" min="1" max="10" class="form-control">
                </div>

                <div class="form-group">
                    <label>Puntos por Empate</label>
                    <input type="number" [(ngModel)]="config.pointsDraw" min="0" max="5" class="form-control">
                </div>

                <div class="form-group">
                    <label>Puntos por Derrota</label>
                    <input type="number" [(ngModel)]="config.pointsLoss" min="0" max="3" class="form-control">
                </div>
            </div>

            <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Reglas de Juego</h3>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="config.tiebreakInThirdSet">
                    <span>Tie-break en el tercer set (si no, se juega hasta ventaja de 2 games)</span>
                </label>
            </div>

            <div class="info-box">
                <strong>üìã Formato de Partidos:</strong>
                <ul>
                    <li>Mejor de 3 sets</li>
                    <li>Sets a {{ config.gamesPerSet }} games</li>
                    <li>Tie-break a {{ config.tiebreakAt }}-{{ config.tiebreakAt }}</li>
                    <li>Tercer set con {{ config.tiebreakInThirdSet ? 'tie-break' : 'ventaja de 2 games' }}</li>
                </ul>
            </div>
        </div>

        <!-- Step 3: Player Selection -->
        <div class="wizard-step" *ngIf="currentStep === 3">
            <h2>Seleccionar Jugadores</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Selecciona un n√∫mero par de jugadores. Se formar√°n parejas autom√°ticamente.
            </p>

            <div class="search-box">
                <input type="text" [(ngModel)]="searchTerm" placeholder="üîç Buscar jugador..." class="form-control">
            </div>

            <div class="selected-count">
                <span>{{ selectedPlayerIds.length }} jugadores seleccionados</span>
                <span style="color: var(--text-secondary);">{{ estimatedPairs }} parejas</span>
            </div>

            <div class="player-list">
                <div *ngFor="let player of filteredPlayers" class="player-item"
                    [class.selected]="isPlayerSelected(player.id)" (click)="togglePlayerSelection(player.id)">
                    <div class="player-info">
                        <span class="player-name">{{ player.name }}</span>
                    </div>
                    <div class="selection-indicator">
                        {{ isPlayerSelected(player.id) ? '‚úì' : '' }}
                    </div>
                </div>
            </div>

            <div *ngIf="filteredPlayers.length === 0" class="empty-state">
                <p>No se encontraron jugadores</p>
            </div>
        </div>

        <!-- Step 4: Pair Configuration (NEW) -->
        <div class="wizard-step" *ngIf="currentStep === 4">
            <h2>Armar Parejas</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                Forma las parejas manualmente o genera parejas aleatorias.
            </p>

            <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                <button (click)="generateRandomPairs()" class="btn btn-secondary">
                    üé≤ Generar Parejas Aleatorias
                </button>
            </div>

            <!-- Configured Pairs -->
            <div *ngIf="pairs.length > 0">
                <h3 style="margin-bottom: 1rem;">Parejas Configuradas ({{ pairs.length }})</h3>
                <div class="pairs-list">
                    <div *ngFor="let pair of pairs; let i = index" class="pair-card">
                        <div class="pair-info">
                            <span class="pair-number">Pareja {{ i + 1 }}</span>
                            <div class="pair-players">
                                <span class="player">{{ getPlayerName(pair.playerA) }}</span>
                                <span class="separator">/</span>
                                <span class="player">{{ getPlayerName(pair.playerB) }}</span>
                            </div>
                        </div>
                        <button (click)="removePair(i)" class="btn-icon btn-danger" title="Eliminar pareja">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>

            <!-- Manual Pairing Section -->
            <div *ngIf="availableForPairing.length >= 2" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem;">Jugadores Disponibles ({{ availableForPairing.length }})</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    Selecciona dos jugadores de la lista para formar una pareja manualmente:
                </p>

                <div class="manual-pairing-grid">
                    <select [(ngModel)]="manualPairA" class="form-control">
                        <option value="">Selecciona Jugador A</option>
                        <option *ngFor="let playerId of availableForPairing" [value]="playerId">
                            {{ getPlayerName(playerId) }}
                        </option>
                    </select>

                    <select [(ngModel)]="manualPairB" class="form-control">
                        <option value="">Selecciona Jugador B</option>
                        <option *ngFor="let playerId of availableForPairing" [value]="playerId">
                            {{ getPlayerName(playerId) }}
                        </option>
                    </select>

                    <button (click)="addManualPair(manualPairA, manualPairB); manualPairA=''; manualPairB=''"
                        [disabled]="!manualPairA || !manualPairB" class="btn btn-primary">
                        + A√±adir Pareja
                    </button>
                </div>
            </div>

            <!-- Info when all paired -->
            <div *ngIf="availableForPairing.length === 0 && pairs.length > 0" class="alert alert-success"
                style="margin-top: 2rem;">
                <strong>‚úÖ Todos los jugadores est√°n emparejados</strong><br>
                Tienes {{ pairs.length }} parejas configuradas. Contin√∫a al siguiente paso para confirmar y crear la
                liga.
            </div>

            <!-- Warning if players remain -->
            <div *ngIf="availableForPairing.length > 0 && availableForPairing.length < 2" class="alert alert-warning"
                style="margin-top: 2rem;">
                <strong>‚ö†Ô∏è Jugador sin pareja</strong><br>
                Queda {{ availableForPairing.length }} jugador sin emparejar. Debes eliminar un jugador o formar una
                √∫ltima pareja.
            </div>
        </div>

        <!-- Step 5: Confirmation (previously step 4) -->
        <div class="wizard-step" *ngIf="currentStep === 5">
            <h2>Confirmar y Crear Liga</h2>

            <div class="summary-card">
                <h3>{{ leagueName }}</h3>
                <div class="summary-row">
                    <span class="label">Tipo:</span>
                    <span class="value">{{ leagueType === 'round_robin' ? 'Todos contra Todos' : leagueType === 'round_robin_playoff' ? 'Todos vs Todos + Playoffs' : 'Grupos + Playoffs'
                        }}</span>
                </div>
                <div class="summary-row" *ngIf="category">
                    <span class="label">Categor√≠a:</span>
                    <span class="value">{{ category }}</span>
                </div>
                <div class="summary-row">
                    <span class="label">Inicio:</span>
                    <span class="value">{{ startDate | date:'fullDate' }}</span>
                </div>
                <div class="summary-row">
                    <span class="label">Parejas:</span>
                    <span class="value">{{ pairs.length }}</span>
                </div>
                <div class="summary-row">
                    <span class="label">Partidos estimados:</span>
                    <span class="value">{{ pairs.length * (pairs.length - 1) / 2 * (config.rounds || 1) }}</span>
                </div>
                <div class="summary-row" *ngIf="leagueType === 'round_robin' || leagueType === 'round_robin_playoff'">
                    <span class="label">Rondas:</span>
                    <span class="value">{{ config.rounds }}</span>
                </div>
                <div class="summary-row" *ngIf="leagueType === 'groups_playoff'">
                    <span class="label">Grupos:</span>
                    <span class="value">{{ config.numberOfGroups }}</span>
                </div>
                <div class="summary-row" *ngIf="leagueType === 'round_robin_playoff'">
                    <span class="label">Liga Oro:</span>
                    <span class="value">Top {{ config.goldPlayoffCount }} parejas</span>
                </div>
                <div class="summary-row" *ngIf="leagueType === 'round_robin_playoff'">
                    <span class="label">Liga Plata:</span>
                    <span class="value">Siguientes {{ config.silverPlayoffCount }} parejas</span>
                </div>
                <div class="summary-row" *ngIf="leagueType === 'round_robin_playoff' && config.relegationCount">
                    <span class="label">Descienden:</span>
                    <span class="value">{{ config.relegationCount }} parejas</span>
                </div>
                <div class="summary-row">
                    <span class="label">Puntuaci√≥n:</span>
                    <span class="value">
                        {{ config.pointsWin }}V / {{ config.pointsDraw }}E / {{ config.pointsLoss }}D
                    </span>
                </div>
            </div>

            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Nota:</strong> Una vez creada la liga, se generar√°n autom√°ticamente las parejas y el
                calendario de partidos.
                Podr√°s modificar fechas y horarios desde el panel de la liga.
            </div>
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="wizard-footer">
        <button *ngIf="currentStep > 1" (click)="previousStep()" class="btn btn-secondary">
            ‚Üê Anterior
        </button>

        <div style="flex: 1;"></div>

        <button *ngIf="currentStep < totalSteps" (click)="nextStep()" class="btn btn-primary">
            Siguiente ‚Üí
        </button>

        <button *ngIf="currentStep === totalSteps" (click)="createLeague()" [disabled]="creatingLeague"
            class="btn btn-success">
            {{ creatingLeague ? 'Creando...' : '‚úì Crear Liga' }}
        </button>
    </div>
</div>