<div class="container fade-in">
    <div *ngIf="loading" class="flex-center" style="min-height: 400px;">
        <div class="spinner"></div>
    </div>

    <div *ngIf="!loading && tournament">
        <!-- Main Error Alert -->
        <div *ngIf="errorMessage && !selectedMatch" class="alert alert-danger mb-4"
            style="background-color: #fee2e2; color: #dc2626; padding: 1rem; border-radius: 0.5rem; border: 1px solid #fca5a5; display: flex; justify-content: space-between; align-items: center;">
            <span>{{ errorMessage }}</span>
            <button (click)="errorMessage = null"
                style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 1.2rem;">&times;</button>
        </div>

        <!-- Header -->
        <div class="flex-between mb-4">
            <div>
                <h1>{{ tournament.name }}</h1>
                <p style="color: var(--text-muted);">
                    {{ tournament.type === 'cuadrangular' ? 'Cuadrangular' : 'Hexagonal' }}
                    ¬∑ {{ tournament.teams.length }} Parejas
                    ¬∑ {{ tournament.matches.length }} Partidos
                    <span *ngIf="tournament.status === 'completed'" class="badge badge-success ml-2">Finalizado</span>
                </p>
            </div>
            <div class="flex gap-2">
                <button *ngIf="canCloseTournament()" (click)="confirmCloseTournament()" class="btn btn-success">
                    üèÜ Finalizar Torneo
                </button>
                <a routerLink="/tournaments" class="btn btn-secondary">
                    ‚Üê Volver
                </a>
            </div>
        </div>

        <div class="grid grid-2">
            <!-- Matches Section -->
            <div class="card" style="grid-column: 1 / -1;">
                <h2>üìã Partidos</h2>
                <div class="matches-grid">
                    <div *ngFor="let match of tournament.matches" class="match-card"
                        (click)="openMatchScoreModal(match)">
                        <div class="match-teams">
                            <div class="team" [ngClass]="getMatchWinnerClass(match, match.team1Id)">
                                <span class="team-name">{{ match.team1?.player1?.name }} & {{ match.team1?.player2?.name
                                    }}</span>
                            </div>
                            <div class="vs">vs</div>
                            <div class="team" [ngClass]="getMatchWinnerClass(match, match.team2Id)">
                                <span class="team-name">{{ match.team2?.player1?.name }} & {{ match.team2?.player2?.name
                                    }}</span>
                            </div>
                        </div>
                        <div class="match-score">
                            <span class="badge badge-info">{{ getMatchDisplay(match) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Standings Section -->
            <div class="card" style="grid-column: 1 / -1;">
                <h2>üèÜ Clasificaci√≥n</h2>
                <table class="table mobile-card-table">
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Pareja</th>
                            <th class="text-center" title="Partidos Jugados">PJ</th>
                            <th class="text-center" title="Partidos Ganados">PG</th>
                            <th class="text-center" title="Partidos Empatados">PE</th>
                            <th class="text-center" title="Partidos Perdidos">PP</th>
                            <th class="text-center">SG</th>
                            <th class="text-center">SP</th>
                            <th class="text-center">DS</th>
                            <th class="text-center">JG</th>
                            <th class="text-center">JP</th>
                            <th class="text-center">DJ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let standing of standings" [class.winner-row]="standing.position === 1">
                            <td data-label="Pos">
                                <strong>{{ standing.position }}</strong>
                                <span *ngIf="standing.position === 1" style="margin-left: 0.5rem;">ü•á</span>
                                <span *ngIf="standing.position === 2" style="margin-left: 0.5rem;">ü•à</span>
                                <span *ngIf="standing.position === 3" style="margin-left: 0.5rem;">ü•â</span>
                            </td>
                            <td data-label="Pareja">
                                <strong>{{ standing.player1Name }}</strong> &
                                <strong>{{ standing.player2Name }}</strong>
                            </td>
                            <td data-label="PJ" class="text-center">{{ standing.matchesPlayed }}</td>
                            <td data-label="PG" class="text-center">{{ standing.matchesWon }}</td>
                            <td data-label="PE" class="text-center">{{ standing.matchesDrawn }}</td>
                            <td data-label="PP" class="text-center">{{ standing.matchesLost }}</td>
                            <td data-label="SG (Sets Ganados)" class="text-center">{{ standing.setsWon }}</td>
                            <td data-label="SP (Sets Perdidos)" class="text-center">{{ standing.setsLost }}</td>
                            <td data-label="DS (Dif. Sets)" class="text-center"
                                [style.color]="standing.setDifference >= 0 ? 'var(--success)' : 'var(--error)'">
                                {{ standing.setDifference > 0 ? '+' : '' }}{{ standing.setDifference }}
                            </td>
                            <td data-label="JG (Juegos Ganados)" class="text-center">{{ standing.gamesWon }}</td>
                            <td data-label="JP (Juegos Perdidos)" class="text-center">{{ standing.gamesLost }}</td>
                            <td data-label="DJ (Dif. Juegos)" class="text-center"
                                [style.color]="standing.gameDifference >= 0 ? 'var(--success)' : 'var(--error)'">
                                {{ standing.gameDifference > 0 ? '+' : '' }}{{ standing.gameDifference }}
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div style="margin-top: var(--spacing-md); color: var(--text-muted); font-size: 0.875rem;">
                    <strong>Leyenda:</strong> PG=Partidos Ganados, PP=Partidos Perdidos, SG=Sets Ganados, SP=Sets
                    Perdidos,
                    DS=Diferencia Sets, JG=Juegos Ganados, JP=Juegos Perdidos, DJ=Diferencia Juegos
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Score Modal -->
<div *ngIf="selectedMatch" class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h2>Ingresar Resultado</h2>
        <div class="match-info mb-2 text-center text-muted">
            Ingresa el resultado por sets
        </div>

        <form [formGroup]="scoreForm" (ngSubmit)="saveScore()">
            <div *ngIf="errorMessage" class="alert alert-danger mb-3"
                style="background-color: #fee2e2; color: #dc2626; padding: 1rem; border-radius: 0.5rem; border: 1px solid #fca5a5;">
                {{ errorMessage }}
            </div>

            <div formArrayName="sets">
                <div *ngFor="let set of sets.controls; let i = index" [formGroupName]="i" class="set-input mb-3"
                    style="border-bottom: 1px solid #eee; padding-bottom: 1rem;">
                    <label class="label text-center mb-2">Set {{ i + 1 }}</label>
                    <div class="flex gap-2 align-items-center justify-content-center">
                        <!-- Team 1 Input Group -->
                        <div style="flex: 1; text-align: center;">
                            <label class="label" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {{ selectedMatch.team1?.player1?.name }} & {{ selectedMatch.team1?.player2?.name }}
                            </label>
                            <input type="number" class="input text-center" formControlName="team1Games" placeholder="0"
                                min="0" />
                        </div>

                        <span style="font-weight: bold; font-size: 1.2rem;">-</span>

                        <!-- Team 2 Input Group -->
                        <div style="flex: 1; text-align: center;">
                            <label class="label" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {{ selectedMatch.team2?.player1?.name }} & {{ selectedMatch.team2?.player2?.name }}
                            </label>
                            <input type="number" class="input text-center" formControlName="team2Games" placeholder="0"
                                min="0" />
                        </div>
                    </div>

                    <!-- Tie-break Inputs (Conditional) -->
                    <div *ngIf="isTieBreakNeeded(i)" class="tiebreak-container fade-in">
                        <div class="tiebreak-label">Tie-break</div>
                        <div class="tiebreak-inputs">
                            <input type="number" class="input text-center" formControlName="tiebreakTeam1"
                                placeholder="0" />
                            <span class="tiebreak-separator">vs</span>
                            <input type="number" class="input text-center" formControlName="tiebreakTeam2"
                                placeholder="0" />
                        </div>
                    </div>

                    <div class="text-center mt-2" *ngIf="sets.length > 1">
                        <button type="button" class="btn btn-danger btn-sm" (click)="removeSet(i)">
                            Eliminar Set
                        </button>
                    </div>
                </div>
            </div>

            <button type="button" class="btn btn-secondary mt-2 w-100" (click)="addSet()" *ngIf="sets.length < 3">
                ‚ûï Agregar Set
            </button>

            <div class="flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    üíæ Guardar Resultado
                </button>
                <button type="button" class="btn btn-secondary" (click)="closeModal()">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Finalize Tournament Modal -->
<div *ngIf="showCloseModal" class="modal-overlay" (click)="cancelCloseTournament()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h2>Finalizar Torneo</h2>
        <p class="mb-4">¬øEst√°s seguro de que deseas finalizar este torneo?</p>
        <p class="mb-4" style="color: var(--text-muted); font-size: 0.9em;">
            Esta acci√≥n calcular√° los puntos finales y actualizar√° el ranking.
            <strong>No se podr√°n modificar los resultados despu√©s.</strong>
        </p>

        <div *ngIf="errorMessage" class="alert alert-danger mb-3"
            style="background-color: #fee2e2; color: #dc2626; padding: 1rem; border-radius: 0.5rem; border: 1px solid #fca5a5;">
            {{ errorMessage }}
        </div>

        <div class="flex gap-2 mt-4">
            <button class="btn btn-success" style="flex: 1;" (click)="finalizeTournament()">
                üèÜ Finalizar
            </button>
            <button class="btn btn-secondary" (click)="cancelCloseTournament()">
                Cancelar
            </button>
        </div>
    </div>
</div>