<div class="container fade-in">
    <div *ngIf="loading" class="flex-center" style="min-height: 400px;">
        <div class="spinner"></div>
    </div>

    <div *ngIf="!loading && tournament">
        <!-- Main Error Alert -->
        <div *ngIf="errorMessage && !selectedMatch" class="alert alert-danger mb-4"
            style="background-color: #fee2e2; color: #dc2626; padding: 1rem; border-radius: 0.5rem; border: 1px solid #fca5a5; display: flex; justify-content: space-between; align-items: center;">
            <span>{{ errorMessage }}</span>
            <button (click)="errorMessage = null"
                style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 1.2rem;">&times;</button>
        </div>

        <!-- Header -->
        <div class="flex-between mb-4">
            <div>
                <h1>{{ tournament.name }}</h1>
                <p style="color: var(--text-muted);">
                    üèüÔ∏è {{ tournament.courts }} Cancha{{ tournament.courts > 1 ? 's' : '' }}
                    ¬∑ {{ tournament.teams.length }} Parejas
                    ¬∑ {{ tournament.matches.length }} Partidos
                    <span *ngIf="hasGroups"> ¬∑ {{ tournament.totalGroups }} Grupos</span>
                    <span *ngIf="tournament.matchesPerTeam && tournament.matchesPerTeam > 0"> ¬∑ {{ tournament.matchesPerTeam }} partidos/pareja</span>
                    <span *ngIf="!tournament.matchesPerTeam || tournament.matchesPerTeam === 0"> ¬∑ Todos contra todos</span>
                    ¬∑ {{ getDurationModeLabel() }}
                    <span *ngIf="tournament.status === 'completed'" class="badge badge-success ml-2">Finalizado</span>
                </p>
            </div>
            <div class="flex gap-2">
                <!-- Generate Elimination (free mode only) -->
                <button *ngIf="canEdit && isFreeModeWithGroups && allGroupMatchesCompleted && !hasEliminationMatches && tournament.status !== 'completed'"
                    (click)="generateElimination()" class="btn btn-info">
                    ‚öîÔ∏è Generar Semifinales
                </button>
                <button *ngIf="canEdit && canGenerateFinal"
                    (click)="generateElimination()" class="btn btn-warning">
                    üèÜ Generar Final
                </button>
                <button *ngIf="canCloseTournament() && canAdmin" (click)="confirmCloseTournament()" class="btn btn-success">
                    üèÜ Finalizar Torneo
                </button>
                <a routerLink="/tournaments" class="btn btn-secondary">
                    ‚Üê Volver
                </a>
            </div>
        </div>

        <!-- Main View Tabs -->
        <div class="main-tabs mb-4">
            <button class="main-tab-btn" [class.active]="activeMainTab === 'matches'" (click)="activeMainTab = 'matches'">
                üìã Partidos
            </button>
            <button class="main-tab-btn" [class.active]="activeMainTab === 'bracket'" (click)="activeMainTab = 'bracket'">
                üèÜ Mapa
            </button>
        </div>

        <!-- ===== BRACKET VIEW ===== -->
        <div *ngIf="activeMainTab === 'bracket'" class="card" style="grid-column: 1 / -1; padding: 0; overflow: hidden;">
            <app-tournament-bracket
                [tournament]="tournament"
                [standings]="standings">
            </app-tournament-bracket>
        </div>

        <!-- ===== MATCHES VIEW ===== -->
        <ng-container *ngIf="activeMainTab === 'matches'">

        <!-- Group Tabs (when multi-group) -->
        <div *ngIf="hasGroups" class="group-tabs mb-4">
            <button class="tab-btn" [class.active]="activeGroupTab === 0" (click)="setActiveGroup(0)">
                Todos
            </button>
            <button *ngFor="let g of groupNumbers" class="tab-btn" [class.active]="activeGroupTab === g"
                (click)="setActiveGroup(g)">
                Grupo {{ g }}
            </button>
        </div>

        <!-- Round Sub-Tabs (when a specific group is selected) -->
        <div *ngIf="hasGroups && activeGroupTab > 0 && activeGroupRounds.length > 1" class="round-subtabs mb-4">
            <button class="subtab-btn" [class.active]="activeRoundTab === 0" (click)="activeRoundTab = 0">
                Todas
            </button>
            <button *ngFor="let r of activeGroupRounds" class="subtab-btn" [class.active]="activeRoundTab === r"
                (click)="activeRoundTab = r">
                Ronda {{ r }}
            </button>
        </div>

        <!-- Round Tabs (when single group, filter by round) -->
        <div *ngIf="!hasGroups && totalRounds > 1" class="group-tabs mb-4">
            <button class="tab-btn" [class.active]="activeGroupTab === 0" (click)="activeGroupTab = 0">
                Todas las Rondas
            </button>
            <button *ngFor="let r of roundNumbers" class="tab-btn" [class.active]="activeGroupTab === r"
                (click)="activeGroupTab = r">
                Ronda {{ r }}
            </button>
        </div>

        <div class="grid grid-2">
            <!-- ===== ROUND-ROBIN MATCHES ===== -->
            <div class="card" style="grid-column: 1 / -1;">
                <h2>üìã Partidos</h2>
                <div class="matches-grid">
                    <div *ngFor="let match of getGroupPhaseMatches()" class="match-card"
                        [class.clickable]="isLoggedIn && match.status !== 'completed'"
                        [hidden]="isMatchHidden(match)"
                        (click)="isLoggedIn ? openMatchScoreModal(match) : null">
                        <div class="match-header">
                            <span class="badge badge-primary badge-sm" *ngIf="hasGroups && match.groupNumber">
                                Grupo {{ match.groupNumber }}
                            </span>
                            <span class="badge badge-secondary badge-sm" *ngIf="match.round">
                                Ronda {{ match.round }}
                            </span>
                            <span class="badge badge-info badge-sm" *ngIf="match.courtNumber">
                                Cancha {{ match.courtNumber }}
                            </span>
                        </div>
                        <div class="match-teams">
                            <div class="team" [ngClass]="getMatchWinnerClass(match, match.team1Id)">
                                <span class="team-name">{{ match.team1?.player1?.name }} & {{ match.team1?.player2?.name }}</span>
                            </div>
                            <div class="vs">vs</div>
                            <div class="team" [ngClass]="getMatchWinnerClass(match, match.team2Id)">
                                <span class="team-name">{{ match.team2?.player1?.name }} & {{ match.team2?.player2?.name }}</span>
                            </div>
                        </div>
                        <div class="match-score">
                            <span class="badge badge-info">{{ getMatchDisplay(match) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== ELIMINATION MATCHES ===== -->
            <div *ngIf="hasEliminationMatches" class="card" style="grid-column: 1 / -1;">
                <h2>‚öîÔ∏è Fase de Eliminaci√≥n</h2>
                <div class="matches-grid">
                    <div *ngFor="let match of getEliminationMatches()" class="match-card elimination-card"
                        [class.clickable]="canEdit && match.status !== 'completed'"
                        (click)="canEdit ? openMatchScoreModal(match) : null">
                        <div class="match-header">
                            <span class="badge badge-sm" [ngClass]="match.round === 2 ? 'badge-success' : 'badge-warning'">{{ getEliminationLabel(match) }}</span>
                            <span class="badge badge-info badge-sm" *ngIf="match.courtNumber">
                                Cancha {{ match.courtNumber }}
                            </span>
                        </div>
                        <div class="match-teams">
                            <div class="team" [ngClass]="getMatchWinnerClass(match, match.team1Id)">
                                <span class="team-name">{{ match.team1?.player1?.name }} & {{ match.team1?.player2?.name }}</span>
                            </div>
                            <div class="vs">vs</div>
                            <div class="team" [ngClass]="getMatchWinnerClass(match, match.team2Id)">
                                <span class="team-name">{{ match.team2?.player1?.name }} & {{ match.team2?.player2?.name }}</span>
                            </div>
                        </div>
                        <div class="match-score">
                            <span class="badge badge-info">{{ getMatchDisplay(match) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info: generate elimination prompt -->
            <div *ngIf="canEdit && isFreeModeWithGroups && allGroupMatchesCompleted && !hasEliminationMatches && tournament.status !== 'completed'"
                class="card" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                <p style="font-size: 1.1rem; margin-bottom: 1rem;">
                    ‚úÖ Todos los partidos del round-robin est√°n completados.
                </p>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Genera las semifinales entre los 4 mejores clasificados.
                </p>
                <button (click)="generateElimination()" class="btn btn-primary btn-lg">
                    ‚öîÔ∏è Generar Semifinales
                </button>
            </div>

            <!-- Info: generate final prompt -->
            <div *ngIf="canEdit && canGenerateFinal"
                class="card" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                <p style="font-size: 1.1rem; margin-bottom: 1rem;">
                    ‚úÖ Ambas semifinales est√°n completadas.
                </p>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Genera la gran final entre los ganadores de las semifinales.
                </p>
                <button (click)="generateElimination()" class="btn btn-warning btn-lg">
                    üèÜ Generar la Final
                </button>
            </div>

            <!-- ===== CLASIFICACI√ìN GENERAL (when elimination exists) ===== -->
            <div *ngIf="hasEliminationMatches" class="card" style="grid-column: 1 / -1;">
                <h2>üèÜ Clasificaci√≥n General <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: normal;">(incluye fase de grupos + eliminaci√≥n)</span></h2>
                <table class="table mobile-card-table">
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Pareja</th>
                            <th class="text-center">Fase</th>
                            <th class="text-center" title="Partidos Jugados">PJ</th>
                            <th class="text-center" title="Partidos Ganados">PG</th>
                            <th class="text-center" title="Partidos Perdidos">PP</th>
                            <th class="text-center" style="color: var(--primary);">Pts</th>
                            <th class="text-center">DS</th>
                            <th class="text-center">DJ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let standing of standings" [class.winner-row]="standing.position === 1">
                            <td data-label="Pos">
                                <strong>{{ standing.position }}</strong>
                                <span *ngIf="standing.position === 1" style="margin-left: 0.25rem;">ü•á</span>
                                <span *ngIf="standing.position === 2" style="margin-left: 0.25rem;">ü•à</span>
                                <span *ngIf="standing.position === 3" style="margin-left: 0.25rem;">ü•â</span>
                            </td>
                            <td data-label="Pareja">
                                <strong>{{ standing.player1Name }}</strong> &
                                <strong>{{ standing.player2Name }}</strong>
                            </td>
                            <td data-label="Fase" class="text-center">
                                <span *ngIf="getEliminationBadge(standing.teamId)" class="badge badge-sm"
                                    [ngClass]="{
                                        'badge-success': getEliminationBadge(standing.teamId).includes('Campe√≥n'),
                                        'badge-warning': getEliminationBadge(standing.teamId).includes('Finalista'),
                                        'badge-info': getEliminationBadge(standing.teamId).includes('Semi')
                                    }">
                                    {{ getEliminationBadge(standing.teamId) }}
                                </span>
                                <span *ngIf="!getEliminationBadge(standing.teamId) && getEliminationPendingBadge(standing.teamId)"
                                    class="badge badge-secondary badge-sm">
                                    {{ getEliminationPendingBadge(standing.teamId) }}
                                </span>
                                <span *ngIf="!getEliminationBadge(standing.teamId) && !getEliminationPendingBadge(standing.teamId)"
                                    style="color: var(--text-muted); font-size: 0.75rem;">Grupos</span>
                            </td>
                            <td data-label="PJ" class="text-center">{{ standing.matchesPlayed }}</td>
                            <td data-label="PG" class="text-center">{{ standing.matchesWon }}</td>
                            <td data-label="PP" class="text-center">{{ standing.matchesLost }}</td>
                            <td data-label="Pts" class="text-center" style="color: var(--primary); font-weight: bold;">{{ standing.points }}</td>
                            <td data-label="DS" class="text-center"
                                [style.color]="standing.setDifference >= 0 ? 'var(--success)' : 'var(--error)'">
                                {{ standing.setDifference > 0 ? '+' : '' }}{{ standing.setDifference }}
                            </td>
                            <td data-label="DJ" class="text-center"
                                [style.color]="standing.gameDifference >= 0 ? 'var(--success)' : 'var(--error)'">
                                {{ standing.gameDifference > 0 ? '+' : '' }}{{ standing.gameDifference }}
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div style="margin-top: var(--spacing-sm); color: var(--text-muted); font-size: 0.8rem;">
                    üìä Esta tabla incluye los resultados de <strong>todas las fases</strong> del torneo (grupos + semifinales + final).
                </div>
            </div>

            <!-- ===== STANDINGS (single group, no elimination) ===== -->
            <div *ngIf="!hasGroups && !hasEliminationMatches" class="card" style="grid-column: 1 / -1;">
                <h2>üèÜ Clasificaci√≥n</h2>
                <ng-container *ngTemplateOutlet="standingsTable; context: { standings: standings }"></ng-container>
            </div>

            <!-- ===== STANDINGS (multi-group) ===== -->
            <ng-container *ngIf="hasGroups">
                <div *ngFor="let g of groupNumbers" class="card" style="grid-column: 1 / -1;"
                    [hidden]="activeGroupTab > 0 && activeGroupTab !== g">
                    <h2>üìã Clasificaci√≥n ‚Äî Grupo {{ g }} <span style="font-size: 0.7rem; color: var(--text-muted); font-weight: normal;">(solo fase de grupos)</span></h2>
                    <ng-container *ngTemplateOutlet="standingsTable; context: { standings: getStandingsForGroup(g) }"></ng-container>
                </div>
            </ng-container>
        </div>

        </ng-container><!-- /matches view -->
    </div>
</div>

<!-- STANDINGS TABLE TEMPLATE -->
<ng-template #standingsTable let-standings="standings">
    <table class="table mobile-card-table">
        <thead>
            <tr>
                <th>Pos</th>
                <th>Pareja</th>
                <th class="text-center" title="Partidos Jugados">PJ</th>
                <th class="text-center" title="Partidos Ganados">PG</th>
                <th class="text-center" title="Partidos Empatados">PE</th>
                <th class="text-center" title="Partidos Perdidos">PP</th>
                <th class="text-center" style="color: var(--primary);">Pts</th>
                <th class="text-center">SG</th>
                <th class="text-center">SP</th>
                <th class="text-center">DS</th>
                <th class="text-center">JG</th>
                <th class="text-center">JP</th>
                <th class="text-center">DJ</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let standing of standings" [class.winner-row]="standing.position === 1">
                <td data-label="Pos">
                    <strong>{{ standing.position }}</strong>
                    <span *ngIf="standing.position === 1" style="margin-left: 0.5rem;">ü•á</span>
                    <span *ngIf="standing.position === 2" style="margin-left: 0.5rem;">ü•à</span>
                    <span *ngIf="standing.position === 3" style="margin-left: 0.5rem;">ü•â</span>
                </td>
                <td data-label="Pareja">
                    <strong>{{ standing.player1Name }}</strong> &
                    <strong>{{ standing.player2Name }}</strong>
                </td>
                <td data-label="PJ" class="text-center">{{ standing.matchesPlayed }}</td>
                <td data-label="PG" class="text-center">{{ standing.matchesWon }}</td>
                <td data-label="PE" class="text-center">{{ standing.matchesDrawn }}</td>
                <td data-label="PP" class="text-center">{{ standing.matchesLost }}</td>
                <td data-label="Pts" class="text-center" style="color: var(--primary); font-weight: bold;">
                    {{ standing.points }}</td>
                <td data-label="SG" class="text-center">{{ standing.setsWon }}</td>
                <td data-label="SP" class="text-center">{{ standing.setsLost }}</td>
                <td data-label="DS" class="text-center"
                    [style.color]="standing.setDifference >= 0 ? 'var(--success)' : 'var(--error)'">
                    {{ standing.setDifference > 0 ? '+' : '' }}{{ standing.setDifference }}
                </td>
                <td data-label="JG" class="text-center">{{ standing.gamesWon }}</td>
                <td data-label="JP" class="text-center">{{ standing.gamesLost }}</td>
                <td data-label="DJ" class="text-center"
                    [style.color]="standing.gameDifference >= 0 ? 'var(--success)' : 'var(--error)'">
                    {{ standing.gameDifference > 0 ? '+' : '' }}{{ standing.gameDifference }}
                </td>
            </tr>
        </tbody>
    </table>
    <div style="margin-top: var(--spacing-md); color: var(--text-muted); font-size: 0.875rem;">
        <strong>Leyenda:</strong> PG=Partidos Ganados, PE=Partidos Empatados, PP=Partidos Perdidos, SG=Sets Ganados, SP=Sets Perdidos,
        DS=Diferencia Sets, JG=Juegos Ganados, JP=Juegos Perdidos, DJ=Diferencia Juegos
    </div>
</ng-template>

<!-- Score Modal -->
<div *ngIf="selectedMatch" class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h2>Ingresar Resultado</h2>
        <div class="match-info mb-2 text-center text-muted">
            Ingresa el resultado por sets
            <div *ngIf="selectedMatch.courtNumber" class="mt-1">
                <span class="badge badge-info">Cancha {{ selectedMatch.courtNumber }}</span>
                <span *ngIf="selectedMatch.phase === 'elimination'" class="badge badge-warning ml-1">Eliminaci√≥n</span>
            </div>
        </div>

        <form [formGroup]="scoreForm" (ngSubmit)="saveScore()">
            <div *ngIf="errorMessage" class="alert alert-danger mb-3"
                style="background-color: #fee2e2; color: #dc2626; padding: 1rem; border-radius: 0.5rem; border: 1px solid #fca5a5;">
                {{ errorMessage }}
            </div>

            <div formArrayName="sets">
                <div *ngFor="let set of sets.controls; let i = index" [formGroupName]="i" class="set-input mb-3"
                    style="border-bottom: 1px solid #eee; padding-bottom: 1rem;">
                    <label class="label text-center mb-2">Set {{ i + 1 }}</label>
                    <div class="flex gap-2 align-items-center justify-content-center">
                        <div style="flex: 1; text-align: center;">
                            <label class="label" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {{ selectedMatch.team1?.player1?.name }} & {{ selectedMatch.team1?.player2?.name }}
                            </label>
                            <input type="number" class="input text-center" formControlName="team1Games" placeholder="0" min="0" />
                        </div>
                        <span style="font-weight: bold; font-size: 1.2rem;">-</span>
                        <div style="flex: 1; text-align: center;">
                            <label class="label" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {{ selectedMatch.team2?.player1?.name }} & {{ selectedMatch.team2?.player2?.name }}
                            </label>
                            <input type="number" class="input text-center" formControlName="team2Games" placeholder="0" min="0" />
                        </div>
                    </div>

                    <!-- Tie-break -->
                    <div *ngIf="isTieBreakNeeded(i)" class="tiebreak-container fade-in">
                        <div class="tiebreak-label">Tie-break</div>
                        <div class="tiebreak-inputs">
                            <input type="number" class="input text-center" formControlName="tiebreakTeam1" placeholder="0" />
                            <span class="tiebreak-separator">vs</span>
                            <input type="number" class="input text-center" formControlName="tiebreakTeam2" placeholder="0" />
                        </div>
                    </div>

                    <div class="text-center mt-2" *ngIf="sets.length > 1">
                        <button type="button" class="btn btn-danger btn-sm" (click)="removeSet(i)">Eliminar Set</button>
                    </div>
                </div>
            </div>

            <button type="button" class="btn btn-secondary mt-2 w-100" (click)="addSet()" *ngIf="sets.length < 3">
                ‚ûï Agregar Set
            </button>

            <div class="flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Guardar Resultado</button>
                <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<!-- Finalize Tournament Modal -->
<div *ngIf="showCloseModal" class="modal-overlay" (click)="cancelCloseTournament()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h2>Finalizar Torneo</h2>
        <p class="mb-4">¬øEst√°s seguro de que deseas finalizar este torneo?</p>
        <p class="mb-4" style="color: var(--text-muted); font-size: 0.9em;">
            Esta acci√≥n calcular√° los puntos finales y actualizar√° el ranking.
            <strong>No se podr√°n modificar los resultados despu√©s.</strong>
        </p>

        <div *ngIf="errorMessage" class="alert alert-danger mb-3"
            style="background-color: #fee2e2; color: #dc2626; padding: 1rem; border-radius: 0.5rem; border: 1px solid #fca5a5;">
            {{ errorMessage }}
        </div>

        <div class="flex gap-2 mt-4">
            <button class="btn btn-success" style="flex: 1;" (click)="finalizeTournament()">üèÜ Finalizar</button>
            <button class="btn btn-secondary" (click)="cancelCloseTournament()">Cancelar</button>
        </div>
    </div>
</div>